from flask import Flask, request, jsonify
from pymongo import MongoClient
from flasgger import Swagger
from flask_cors import CORS
from flasgger.utils import swag_from
import nmap
from cve_search import db as cve_db
from cve_search.lib.Config import Configuration
import re
import json
import requests
from JSONEncoder import JSONEncoder
import shlex
import subprocess
import os
import sys
from dateutil.parser import parse as parse_datetime
from xml.sax import make_parser
from cve_handler import CVEHandler

client = MongoClient('127.0.0.1', 27017)
db = client['cvedb']
vulnscan_collection = db['todos']

#db_mgmt.py
defaultvalue = {}
defaultvalue['cwe'] = "Unknown"

app = Flask(__name__)
CORS(app)
Swagger(app)
app.debug = True
nm = nmap.PortScanner()

@app.route('/alive')
def healthz():
    return 'I''m ok, thanks!'

@app.route('/update_db', methods=['POST'])
@swag_from('api-docs/update_db.yml')
def update_db():
    """
    GET: Returns the current CVE version on the database
    """

    response = update_collections()
    # runPath = os.path.dirname(os.path.realpath(__file__))
    # process = subprocess.Popen([sys.executable, os.path.join(runPath, "../sbin/db_updater.py"), "-civ"], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    # out, err = process.communicate()
    # output="%s\n\nErrors:\n%s"%(str(out,'utf-8'),str(err,'utf-8')) if err else str(out,'utf-8')
    # return jsonify({"updateOutput": output, "status": "db_updated"})


    return jsonify(response)

@app.route('/last_scan', methods=['GET'])
@swag_from('api-docs/last_scan.yml')
def get_last_scan():
    """
    GET: Returns the current CVE version on the database
    """
    last_id = history_last_id()
    print('last_id before '+str(last_id))
    last_id = last_id != None and last_id or 1
    print('last_id after '+str(last_id))
    cursor = db['history'].find({'id':last_id})

    results = [item for item in cursor]
    return JSONEncoder().encode(results)


# @app.route('/scan_services', methods=['POST'])
# @swag_from('api-docs/scan_services.yml')
def scan_services_by_ip(ip):
    """
    Scan ports and services for a given IP address.
    DATA: results = {'ip': '', 'policy_key': '','results': []}
    POST: Returns an object with ip, policy and a list of results
          containing the services with its versions,
          Returns the CPE name.
    """
    #params = request.get_json()
    params = ip
    nm.scan(str(params['ip']))
    all_ports_detected = nm[params['ip']]['tcp']
    results = {'ip': '', 'policy_key': '','services': []}
    results['ip'] = params['ip']
    results['policy_key'] = params['policy_key']
    for port in all_ports_detected:
        port_scan_result = all_ports_detected[port]
        port_scan_result['port'] = port
        if (int(port) == 443):
            port_scan_result['tls_versions'] = scan_for_tls_support(params['ip'])
        results['services'].append(port_scan_result)

    #return jsonify(results)
    return results

def scan_for_tls_support(ip):
    ssl_results = nm.scan(ip, arguments="-p 443 --script ssl-enum-ciphers")
    ssl_ciphers_results = ssl_results['scan'][ip]['tcp'][443]['script']['ssl-enum-ciphers']
    ssl_tls_version_matches = re.findall('TLSv\d.\d', ssl_ciphers_results, re.DOTALL)
    return ssl_tls_version_matches

# @app.route('/search_vulnerabilities', methods=['POST'])
# @swag_from('api-docs/search_vulnerabilities.yml')
def search_vulnerabilities(service):
    """Scan vulnerabiliies by given CPE name.
    """
    #params = request.get_json()
    #response = {'cpe': params['cpe'], 'vulnerabilities': []}
    response = {'cpe': service['cpe'], 'vulnerabilities': []}
    for item in cve_db.cvesForCPE(service['cpe']):
        vulnerability = {'vulnerability': '','vulnerability_text': '", "score": "'}
        vulnerability['vulnerability'] = item['id']
        vulnerability['vulnerability_text'] = item['summary']
        vulnerability['score'] = item['cvss']
        response['vulnerabilities'].append(vulnerability)
    return response

def save_scan_result(data):
    response = ''
    try:
        r = requests.post('https://api.ersins.com/scan/save', json = data)
        response = r.json()
    except:
        print('There is a erro on saving scan reulst')
    return response

@app.route('/start_scan', methods=['POST'])
@swag_from('api-docs/start_scan.yml')
def start_scan():
    """Scan vulnerabiliies by given CPE name.
    """
    # ips = requests.get('https://api.ersins.com/find')
    ips = [{'ip': '127.0.0.1', 'policy_key': '123'}]
    responses = []

    services = []
    for ip in ips:
        services = scan_services_by_ip(ip)
        for service in services['services']:
            if service['cpe'] != '':
                service['cpe'] = service['cpe'][7:]
                vulnerabilities = search_vulnerabilities(service)
                response_to_save_api = {'ip': '', 'policy_key':'', 'vulnerabilities': []}
                response_to_save_api['ip'] = ip['ip']
                response_to_save_api['policy_key'] = ip['policy_key']
                response_to_save_api['vulnerabilities'] = vulnerabilities['vulnerabilities']
                #Saving scan result to api provided
                save_scan_result(response_to_save_api)
                for vulnerability in vulnerabilities['vulnerabilities']:
                    response = {}
                    response['ip'] = ip['ip']
                    response['policy_key'] = ip['policy_key']
                    response['port'] = service['port']
                    response['service'] = service['name']
                    response['version'] = service['version']
                    response['vulnerability'] = vulnerability['vulnerability']
                    response['vulnerability_text'] = vulnerability['vulnerability_text']
                    response['score'] = vulnerability['score']
                    responses.append(response)

    print(response_to_save_api)
    try:
        requests.post('http://0.0.0.0:5000/history_bulk_insert', json=responses)
    except:
        print('there is an error trying to history bulk insert')
    return jsonify(responses)


@app.route('/history_bulk_insert', methods=['POST'])
@swag_from('api-docs/history_bulk_insert.yml')
def history_bulk_insert():
    """Bulk insert history of scans on database.
    """
    params = request.get_json()
    last_id = history_last_id()
    print('last_id before '+str(last_id))
    last_id = last_id != None and int(last_id) + 1 or 1
    print('last_id after '+str(last_id))
    response = []
    for item in params['history_list']:
        obj = {}
        obj['id'] = last_id
        obj['ip'] = item['ip']
        obj['port'] = item['port']
        obj['score'] = item['score']
        obj['service'] = item['service']
        obj['version'] = item['version']
        obj['vulnerability'] = item['vulnerability']
        obj['vulnerability_text'] = item['vulnerability_text']
        response.append(obj)
    result = db['history'].insert_many(response)
    # return result.inserted_ids
    # return db['history'].insert(obj)
    return '\nsuccess'

def history_last_id():
    """Retrieve last id of scan results history.
    """
    results = db['history'].find_one(sort=[("id", -1)])
    if results != None:
        results = results["id"]
    return results

def update_collections():
    # init parts of the file names to enable looped file download
    file_prefix = "nvdcve-2.0-"
    file_suffix = ".xml.gz"
    file_mod = "modified"
    file_rec = "recent"
    # get the 'modified' file
    getfile = file_prefix + file_mod + file_suffix
    try:
        (f, r) = Configuration.getFile(Configuration.getFeedURL('cve') + getfile)
    except:
        sys.exit("Cannot open url %s. Bad URL or not connected to the internet?"%(Configuration.getFeedURL("cve") + getfile))
    i = cve_db.getInfo("cves")
    last_modified = parse_datetime(r.headers['last-modified'], ignoretz=True)
    if i is not None:
        if last_modified == i['last-modified']:
            print("Not modified")
            return "Not modified"
    cve_db.setColUpdate("cves", last_modified)

    # get your parser on !!
    parser = make_parser()
    ch = CVEHandler()
    parser.setContentHandler(ch)
    parser.parse(f)
    for item in ch.cves:
        # check if the CVE already exists.
        x = cve_db.getCVE(item['id'])
        # if so, update the entry.
        if x:
            if 'cvss' not in item:
                item['cvss'] = None
            if 'cwe' not in item:
                item['cwe'] = defaultvalue['cwe']
            cve_db.updateCVE(item)
        else:
            cve_db.insertCVE(item)
    # get the 'recent' file
    getfile = file_prefix + file_rec + file_suffix
    try:
        (f, r) = Configuration.getFile(Configuration.getFeedURL('cve') + getfile)
    except:
        sys.exit("Cannot open url %s. Bad URL or not connected to the internet?"%(Configuration.getFeedURL("cve") + getfile))
    parser = make_parser()
    ch = CVEHandler()
    parser.setContentHandler(ch)
    parser.parse(f)
    for item in progressbar(ch.cves):
        # check if the CVE already exists.
        x = cve_db.getCVE(item['id'])
        # if so, update the entry.
        if x:
            if args.v:
                print("item found : " + item['id'])
            if 'cvss' not in item:
                item['cvss'] = None
            else:
                item['cvss'] = float(item['cvss'])
            if 'cwe' not in item:
                item['cwe'] = defaultvalue['cwe']
            cve_db.updateCVE(item)
        # if not, create it.
        else:
            cve_db.insertCVE(item)
    return 'success'

# if __name__ == '__main__':
#     app.run(debug=True,host='0.0.0.0')
