from flask import Flask, request, jsonify
from pymongo import MongoClient
from flasgger import Swagger
from flasgger.utils import swag_from
import nmap

client = MongoClient('127.0.0.1', 27017)
db = client['test']
vulnscan_collection = db['todos']

app = Flask(__name__)
Swagger(app)
app.debug = True

@app.route('/alive')
def healthz():
    return 'I''m ok, thanks!'

@app.route('/get_last_cve', methods=['GET'])
def get_last_cve():
    """
    GET: Returns the last CVE version available to update
    """
    return str('CVE-01-01-2017')

@app.route('/get_current_cve', methods=['GET'])
def get_current_cve():
    """
    GET: Returns the current CVE version on the database
    """
    return str('CVE-01-01-2017')

@app.route('/update_cve', methods=['POST'])
def update_to_last_cve():
    """
    GET: Returns the current CVE version on the database
    """
    return str('CVE-01-01-2017')

@app.route('/scan_services', methods=['POST'])
@swag_from('api-docs/scan_services.yml')
def scan_services_by_ip():
    """
    Scan ports and services for a given IP address.
    DATA: results = {'ip': '', 'policy': '','results': []}
    POST: Returns an object with ip, policy and a list of results
          containing the services with its versions,
          Returns the CPE name.
    """
    params = request.get_json()
    nm = nmap.PortScanner()
    nm.scan(str(params['ip']))
    all_ports_detected = nm[params['ip']]['tcp']
    results = {'ip': '', 'policy': '','results': []}
    results['ip'] = params['ip']
    results['policy'] = params['policy']
    for port in all_ports_detected:
        port_scan_result = all_ports_detected[port]
        port_scan_result['port'] = port
        results['results'].append(port_scan_result)
        if (int(port) == 443):
            #TODO - add tls version support check
            print('PORT 443 IS OPEN')
        else:
            print('PORT 443 IS CLOSED')

    return jsonify(results)

@app.route('/search_vulnerabilities', methods=['POST'])
@swag_from('api-docs/scan_services.yml')
def scan_vulnerabilities_by_cpe():
    """Scan vulnerabiliies by given CPE name.

    DATA:  {'cpe':'', 'results':[]}
    POST: Returns an object with the CPE name, and a list of results
          containing the vulnerabilities description matching.
    """
    params = request.get_json()
    results = {'cpe':'', 'results':[]}
    results['cpe'] = params['cpe']
    for result in vulnscan_collection.find({"text": params['cpe']}):
        results['results'].append(result['text'])
        print(result)

    return jsonify(results)

if __name__ == '__main__':
    app.run(debug=True,host='0.0.0.0')
