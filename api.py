from flask import Flask, request, jsonify
from pymongo import MongoClient
from flasgger import Swagger
from flask_cors import CORS
from flasgger.utils import swag_from
import nmap
from cve_search import db as cve_db
import re
import json
from JSONEncoder import JSONEncoder

client = MongoClient('127.0.0.1', 27017)
db = client['cvedb']
vulnscan_collection = db['todos']

app = Flask(__name__)
CORS(app)
Swagger(app)
app.debug = True
nm = nmap.PortScanner()

@app.route('/alive')
def healthz():
    return 'I''m ok, thanks!'

@app.route('/get_last_cve', methods=['GET'])
def get_last_cve():
    """
    GET: Returns the last CVE version available to update
    """
    return str('CVE-01-01-2017')

@app.route('/get_current_cve', methods=['GET'])
def get_current_cve():
    """
    GET: Returns the current CVE version on the database
    """
    return str('CVE-01-01-2017')

@app.route('/update_db', methods=['POST'])
@swag_from('api-docs/update_db.yml')
def update_db():
    """
    GET: Returns the current CVE version on the database
    """
    return str('CVE-01-01-2017')

@app.route('/last_scan', methods=['GET'])
@swag_from('api-docs/last_scan.yml')
def get_last_scan():
    """
    GET: Returns the current CVE version on the database
    """
    last_id = history_last_id()
    print('last_id before '+str(last_id))
    last_id = last_id != None and last_id or 1
    print('last_id after '+str(last_id))
    cursor = db['history'].find({'id':last_id})

    results = [item for item in cursor]
    return JSONEncoder().encode(results)


@app.route('/scan_services', methods=['POST'])
@swag_from('api-docs/scan_services.yml')
def scan_services_by_ip():
    """
    Scan ports and services for a given IP address.
    DATA: results = {'ip': '', 'policy_id': '','results': []}
    POST: Returns an object with ip, policy and a list of results
          containing the services with its versions,
          Returns the CPE name.
    """
    params = request.get_json()
    nm.scan(str(params['ip']))
    all_ports_detected = nm[params['ip']]['tcp']
    results = {'ip': '', 'policy_id': '','services': []}
    results['ip'] = params['ip']
    results['policy_id'] = params['policy_id']
    for port in all_ports_detected:
        port_scan_result = all_ports_detected[port]
        port_scan_result['port'] = port
        if (int(port) == 443):
            port_scan_result['tls_versions'] = scan_for_tls_support(params['ip'])
        results['services'].append(port_scan_result)

    return jsonify(results)

def scan_for_tls_support(ip):
    ssl_results = nm.scan(ip, arguments="-p 443 --script ssl-enum-ciphers")
    ssl_ciphers_results = ssl_results['scan'][ip]['tcp'][443]['script']['ssl-enum-ciphers']
    ssl_tls_version_matches = re.findall('TLSv\d.\d', ssl_ciphers_results, re.DOTALL)
    return ssl_tls_version_matches

@app.route('/search_vulnerabilities', methods=['POST'])
@swag_from('api-docs/search_vulnerabilities.yml')
def search_vulnerabilities():
    """Scan vulnerabiliies by given CPE name.
    """
    params = request.get_json()
    response = {'cpe': params['cpe'], 'vulnerabilities': []}
    for item in cve_db.cvesForCPE(params['cpe']):
        vulnerability = {'vulnerability': '','vulnerability_text': '", "score": "'}
        vulnerability['vulnerability'] = item['id']
        vulnerability['vulnerability_text'] = item['summary']
        vulnerability['score'] = item['cvss']
        response['vulnerabilities'].append(vulnerability)
    return jsonify(response)

@app.route('/history_bulk_insert', methods=['POST'])
@swag_from('api-docs/history_bulk_insert.yml')
def history_bulk_insert():
    """Bulk insert history of scans on database.
    """
    params = request.get_json()
    last_id = history_last_id()
    print('last_id before '+str(last_id))
    last_id = last_id != None and int(last_id) + 1 or 1
    print('last_id after '+str(last_id))
    response = []
    for item in params['history_list']:
        obj = {}
        obj['id'] = last_id
        obj['ip'] = item['ip']
        obj['port'] = item['port']
        obj['score'] = item['score']
        obj['service'] = item['service']
        obj['version'] = item['version']
        obj['vulnerability'] = item['vulnerability']
        obj['vulnerability_text'] = item['vulnerability_text']
        response.append(obj)
    result = db['history'].insert_many(response)
    # return result.inserted_ids
    # return db['history'].insert(obj)
    return '\nsuccess'

def history_last_id():
    """Retrieve last id of scan results history.
    """
    results = db['history'].find_one(sort=[("id", -1)])["id"]
    return results

if __name__ == '__main__':
    app.run(debug=True,host='0.0.0.0')
